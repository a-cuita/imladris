<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://script.google.com https://script.googleusercontent.com; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src https://script.google.com https://script.googleusercontent.com;">
    <title>IMLADRIS - Integrated Models Linking Analytics Directly, Retroactively, and In-Situ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #1a1f2e;
            --bg-tertiary: #2a2f3e;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --text-tertiary: #6b7280;
            --accent-primary: #3b82f6;
            --accent-secondary: #60a5fa;
            --border-primary: #374151;
            --border-secondary: #4b5563;
            --success: #10b981;
            --warning: #fbbf24;
            --error: #ef4444;
            --harmony: #10b981;
            --caution: #fbbf24;
            --alert: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
            padding: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
        }

        .container {
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* =========================== */
        /* AUTHENTICATION SCREENS */
        /* =========================== */

        .auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
        }

        .auth-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 2rem;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-header h1 {
            font-size: 24px;
            margin-bottom: 0.5rem;
            color: var(--accent-primary);
        }

        .auth-header .subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-primary);
            border-radius: 8px;
            font-size: 15px;
            color: var(--text-primary);
            background: var(--bg-tertiary);
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .pin-input-wrapper {
            position: relative;
        }

        .pin-input-wrapper input {
            padding-right: 45px;
            text-transform: lowercase;
        }

        .pin-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 18px;
            color: var(--text-tertiary);
            user-select: none;
            transition: color 0.2s;
        }

        .pin-toggle:hover {
            color: var(--accent-primary);
        }

        .form-helper {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59,130,246,0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--accent-primary);
            border: 2px solid var(--accent-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(59,130,246,0.1);
        }

        .btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
            cursor: not-allowed;
            transform: none;
        }

        .auth-toggle {
            text-align: center;
            font-size: 13px;
            color: var(--accent-primary);
            cursor: pointer;
            margin-top: 1rem;
            font-weight: 600;
        }

        .auth-toggle:hover {
            text-decoration: underline;
        }

        .custom-org-input {
            margin-top: 0.75rem;
            display: none;
        }

        .custom-org-input.show {
            display: block;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background: rgba(16,185,129,0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .message.error {
            background: rgba(239,68,68,0.1);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .message.warning {
            background: rgba(251,191,36,0.1);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        /* =========================== */
        /* MAIN APP LAYOUT */
        /* =========================== */

        .app-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .app-header-user {
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .app-header-user .user-icon {
            font-size: 20px;
        }

        .session-alert {
            background: rgba(251,191,36,0.1);
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin: 1rem;
            font-size: 13px;
            color: var(--warning);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-logout {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            border-color: var(--error);
            color: var(--error);
        }

        /* =========================== */
        /* CATEGORY/IDX SELECTOR CHIPS */
        /* =========================== */

        .selector-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            margin-bottom: 0.75rem;
        }

        .selector-header:hover {
            color: var(--accent-secondary);
        }

        .selector-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent-primary);
        }

        .selector-chips {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            -webkit-overflow-scrolling: touch;
        }

        .selector-chips::-webkit-scrollbar {
            height: 6px;
        }

        .selector-chips::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .selector-chips::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 3px;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 10px 14px;
            min-height: 44px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-primary);
            border-radius: 20px;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            user-select: none;
        }

        .chip:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .chip.selected {
            background: rgba(59,130,246,0.2);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .chip .check {
            font-size: 14px;
            color: var(--success);
            display: none;
        }

        .chip.selected .check {
            display: inline;
        }

        .chip .warning-icon {
            font-size: 16px;
            color: var(--warning);
        }

        .selector-section.collapsed .selector-chips {
            display: none;
        }

        /* =========================== */
        /* GRAPH AREA */
        /* =========================== */

        .graph-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            overflow-x: auto;
        }

        .graph-ascii {
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            line-height: 1.2;
            white-space: pre;
            overflow-x: auto;
            color: var(--text-primary);
        }

        .graph-ascii.font-small { font-size: 10px; }
        .graph-ascii.font-medium { font-size: 12px; }
        .graph-ascii.font-large { font-size: 14px; }
        .graph-ascii.font-xlarge { font-size: 16px; }

        .svg-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        /* =========================== */
        /* VALIDATION PANEL */
        /* =========================== */

        .validation-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .validation-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .validation-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .validation-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-indicator.harmony { background: var(--harmony); box-shadow: 0 0 10px var(--harmony); }
        .status-indicator.caution { background: var(--caution); box-shadow: 0 0 10px var(--caution); }
        .status-indicator.alert { background: var(--alert); box-shadow: 0 0 10px var(--alert); }

        .status-text {
            flex: 1;
        }

        .status-text .status-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .status-text .status-value {
            font-size: 18px;
            font-weight: 700;
        }

        .validation-timeline {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .timeline-mini {
            height: 60px;
            display: flex;
            align-items: center;
            gap: 2px;
            overflow-x: auto;
        }

        .timeline-day {
            width: 8px;
            height: 100%;
            border-radius: 2px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .timeline-day:hover {
            opacity: 0.7;
        }

        .timeline-day.harmony { background: var(--harmony); }
        .timeline-day.caution { background: var(--caution); }
        .timeline-day.alert { background: var(--alert); }
        .timeline-day.none { background: var(--bg-primary); }

        /* =========================== */
        /* DATA ENTRY MODAL */
        /* =========================== */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 1rem;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--error);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .category-input-group {
            display: flex;
            flex-direction: column;
        }

        .category-input-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }

        .category-input-group input {
            padding: 10px;
            border: 2px solid var(--border-primary);
            border-radius: 6px;
            font-size: 15px;
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .category-input-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .notes-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid var(--border-primary);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-primary);
            background: var(--bg-tertiary);
            font-family: inherit;
            resize: vertical;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .char-counter {
            font-size: 11px;
            color: var(--text-tertiary);
            text-align: right;
            margin-top: 4px;
        }

        /* =========================== */
        /* CONTROLS BAR */
        /* =========================== */

        .controls-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 10px 16px;
            min-height: 44px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            border-color: var(--accent-primary);
            background: rgba(59,130,246,0.1);
        }

        .btn-icon .icon {
            font-size: 18px;
        }

        /* =========================== */
        /* UTILITY CLASSES */
        /* =========================== */

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* =========================== */
        /* RESPONSIVE */
        /* =========================== */

        @media (max-width: 768px) {
            body {
                font-size: 15px;
            }

            .container {
                padding: 0.5rem;
            }

            .auth-card {
                padding: 1.5rem;
            }

            .category-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .controls-bar {
                flex-direction: column;
            }

            .btn-icon {
                width: 100%;
                justify-content: center;
            }
        }

        /* =========================== */
        /* PULSATING ANIMATION */
        /* =========================== */

        @keyframes pulsate {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .pulsating {
            animation: pulsate 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <!-- ================================ -->
    <!-- LOGIN SCREEN -->
    <!-- ================================ -->
    <div id="loginScreen" class="auth-screen">
        <div class="auth-card">
            <div class="auth-header">
                <h1>üåä IMLADRIS</h1>
                <div class="subtitle">Integrated Models Linking Analytics Directly, Retroactively, and In-Situ</div>
            </div>

            <div id="message" class="message"></div>

            <!-- LOGIN FORM -->
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">Handle</label>
                    <input type="text" class="form-input" id="loginHandle" placeholder="Your handle" autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="form-label">PIN</label>
                    <div class="pin-input-wrapper">
                        <input type="password" class="form-input" id="loginPIN" placeholder="e.g. jb07" maxlength="4" autocomplete="off">
                        <span class="pin-toggle" onclick="togglePIN('loginPIN', this)">üëÅÔ∏è</span>
                    </div>
                </div>
                <button class="btn btn-primary" id="loginBtn" disabled>Log In</button>
                <div class="auth-toggle" id="showCreateToggle">New here? Create a profile ‚Üí</div>
                <div class="auth-toggle" id="showResetToggle">Forgot PIN? Reset ‚Üí</div>
            </div>

            <!-- CREATE PROFILE FORM -->
            <div id="createForm" class="hidden">
                <div class="form-group">
                    <label class="form-label">Handle</label>
                    <input type="text" class="form-input" id="createHandle" placeholder="Choose a handle (2+ characters)" autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="form-label">PIN (2 letters + 2 numbers)</label>
                    <div class="pin-input-wrapper">
                        <input type="password" class="form-input" id="createPIN" placeholder="e.g. jb07" maxlength="4" autocomplete="off">
                        <span class="pin-toggle" onclick="togglePIN('createPIN', this)">üëÅÔ∏è</span>
                    </div>
                    <div class="form-helper">Format: two letters followed by two numbers</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Organization</label>
                    <select class="form-select" id="createOrgSelect">
                        <option value="">Select organization...</option>
                        <option value="None">None</option>
                        <option value="Personal">Personal</option>
                        <option value="HostEase">HostEase (Property Management)</option>
                        <option value="Osprey">Osprey (Restaurant Sustainability)</option>
                        <option value="Other">Other...</option>
                    </select>
                    <div class="custom-org-input" id="createCustomOrg">
                        <input type="text" class="form-input" id="createCustomOrgText" placeholder="Enter organization name">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Email (for PIN reset)</label>
                    <input type="email" class="form-input" id="createEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Security Question</label>
                    <select class="form-select" id="createSecurityQuestion">
                        <option value="">Select a question...</option>
                        <option value="What was your first pet's name?">What was your first pet's name?</option>
                        <option value="What city were you born in?">What city were you born in?</option>
                        <option value="What is your favorite book?">What is your favorite book?</option>
                        <option value="What is your mother's maiden name?">What is your mother's maiden name?</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Answer</label>
                    <input type="text" class="form-input" id="createSecurityAnswer" placeholder="Your answer">
                </div>
                <button class="btn btn-primary" id="createProfileBtn" disabled>Create Profile</button>
                <div class="auth-toggle" id="showLoginToggle">Already have a profile? Log in ‚Üí</div>
            </div>

            <!-- PIN RESET FORM -->
            <div id="resetForm" class="hidden">
                <div id="resetStep1">
                    <div class="form-group">
                        <label class="form-label">Handle</label>
                        <input type="text" class="form-input" id="resetHandle" placeholder="Your handle" autocomplete="off">
                    </div>
                    <button class="btn btn-primary" id="resetNextBtn" disabled>Next</button>
                </div>

                <div id="resetStep2" class="hidden">
                    <div class="form-group">
                        <label class="form-label" id="resetQuestionLabel">Security Question</label>
                        <input type="text" class="form-input" id="resetAnswer" placeholder="Your answer">
                    </div>
                    <button class="btn btn-primary" id="resetVerifyBtn">Verify Answer</button>
                    <div style="text-align: center; margin: 1rem 0; color: var(--text-secondary);">‚Äî OR ‚Äî</div>
                    <button class="btn btn-secondary" id="resetEmailBtn">Send Code to Email</button>
                </div>

                <div id="resetStep3" class="hidden">
                    <div class="form-group">
                        <label class="form-label">Verification Code</label>
                        <input type="text" class="form-input" id="resetCode" placeholder="6-digit code" maxlength="6">
                        <div class="form-helper" id="resetEmailMasked"></div>
                    </div>
                    <button class="btn btn-primary" id="resetCodeVerifyBtn">Verify Code</button>
                </div>

                <div id="resetStep4" class="hidden">
                    <div class="form-group">
                        <label class="form-label">New PIN</label>
                        <div class="pin-input-wrapper">
                            <input type="password" class="form-input" id="resetNewPIN" placeholder="e.g. jb07" maxlength="4">
                            <span class="pin-toggle" onclick="togglePIN('resetNewPIN', this)">üëÅÔ∏è</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm PIN</label>
                        <div class="pin-input-wrapper">
                            <input type="password" class="form-input" id="resetConfirmPIN" placeholder="e.g. jb07" maxlength="4">
                            <span class="pin-toggle" onclick="togglePIN('resetConfirmPIN', this)">üëÅÔ∏è</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="resetFinalBtn" disabled>Reset PIN</button>
                </div>

                <div class="auth-toggle" id="showLoginFromReset">Back to login ‚Üí</div>
            </div>
        </div>
    </div>

    <!-- ================================ -->
    <!-- MAIN APP -->
    <!-- ================================ -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <div class="app-header">
            <div class="app-header-user">
                <span class="user-icon">üë§</span>
                <span id="displayHandle">User</span>
                <span style="color: var(--text-secondary);">@</span>
                <span id="displayOrg" style="color: var(--text-secondary);">Organization</span>
            </div>
            <button class="btn-logout" id="logoutBtn">Logout</button>
        </div>

        <!-- Session Alert -->
        <div class="session-alert">
            <div>
                ‚ö†Ô∏è <strong>Session active until manual logout</strong> ‚Ä¢ Last activity: <span id="lastActivity">just now</span>
            </div>
        </div>

        <div class="container">
            <!-- Controls -->
            <div class="controls-bar">
                <button class="btn-icon" id="addEntryBtn">
                    <span class="icon">‚ûï</span>
                    <span>Add Entry</span>
                </button>
                <button class="btn-icon" id="refreshBtn">
                    <span class="icon">üîÑ</span>
                    <span>Refresh Data</span>
                </button>
                <button class="btn-icon" id="settingsBtn">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </button>
                <button class="btn-icon" id="exportBtn">
                    <span class="icon">üìä</span>
                    <span>Export</span>
                </button>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading">Loading data</div>

            <!-- Main Content -->
            <div id="mainContent" class="hidden">
                <!-- Validation Panel -->
                <div class="validation-panel" id="validationPanel">
                    <div class="validation-header">
                        <h3>üìä Perception vs Reality Analysis</h3>
                    </div>
                    <div class="validation-status">
                        <div class="status-indicator harmony" id="statusIndicator"></div>
                        <div class="status-text">
                            <div class="status-label">Current Status</div>
                            <div class="status-value" id="statusValue">HARMONY</div>
                        </div>
                        <div class="status-text">
                            <div class="status-label">Divergence</div>
                            <div class="status-value" id="divergenceValue">0.0œÉ</div>
                        </div>
                    </div>
                    <div class="validation-timeline">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 0.5rem;">Last 30 Days</div>
                        <div class="timeline-mini" id="timelineMini"></div>
                    </div>
                </div>

                <!-- Category Selector -->
                <div class="selector-section" id="categorySelector">
                    <div class="selector-header" onclick="toggleSelector('categorySelector')">
                        <div>
                            <span class="selector-title">Categories</span>
                            <span style="color: var(--text-secondary); font-size: 13px; margin-left: 0.5rem;" id="categoriesCount">(24)</span>
                        </div>
                        <span id="categorySelectorIcon">‚ñº</span>
                    </div>
                    <div class="selector-chips" id="categoryChips"></div>
                </div>

                <!-- IDX Selector -->
                <div class="selector-section" id="idxSelector">
                    <div class="selector-header" onclick="toggleSelector('idxSelector')">
                        <div>
                            <span class="selector-title">Indices</span>
                            <span style="color: var(--text-secondary); font-size: 13px; margin-left: 0.5rem;" id="indicesCount">(0)</span>
                        </div>
                        <span id="idxSelectorIcon">‚ñº</span>
                    </div>
                    <div class="selector-chips" id="idxChips"></div>
                </div>

                <!-- Graph -->
                <div class="graph-container">
                    <div class="graph-ascii font-medium" id="graphAscii">Loading graph...</div>
                    <svg class="svg-overlay" id="svgOverlay"></svg>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================ -->
    <!-- DATA ENTRY MODAL -->
    <!-- ================================ -->
    <div class="modal-overlay" id="entryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Entry</h3>
                <span class="modal-close" onclick="closeEntryModal()">‚úï</span>
            </div>

            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" class="form-input" id="entryDate">
            </div>

            <div class="form-group">
                <label class="form-label">Overall Rating (OVR)</label>
                <input type="number" class="form-input" id="entryOVR" placeholder="0-10" min="0" max="10" step="0.1">
            </div>

            <div class="form-group">
                <label class="form-label">Categories</label>
                <div class="category-grid" id="categoryInputs"></div>
            </div>

            <div class="form-group">
                <label class="form-label">Notes (optional)</label>
                <textarea class="notes-textarea" id="entryNotes" maxlength="1000" placeholder="Describe your day..."></textarea>
                <div class="char-counter"><span id="notesCounter">0</span> / 1000 characters</div>
            </div>

            <button class="btn btn-primary" id="submitEntryBtn">Submit Entry</button>
            <button class="btn btn-secondary" onclick="closeEntryModal()">Cancel</button>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwOCod_6BsCPMRGzQkBLCr2-V2MJ5k1L5QmKh_9iQdLrZgg4kBundwu52mmymmIlWXY/exec';

        const CATEGORIES = ['pro', 'scl', 'fit', 'lov', 'gnh', 'fnc', 'usl', 'fth', 'rst', 'pyn', 'stx', 'emo', 'fml', 'crt', 'dyt', 'ptn', 'ppl', 'pol', 'anx', 'mtv', 'imp', 'opt', 'spr', 'foc'];

        // ==========================================
        // STATE
        // ==========================================
        let currentUser = {
            userId: null,
            handle: null,
            organization: null
        };

        let appData = {
            rawData: [],
            categories: [],
            categoryDescriptors: {},
            idxRules: [],
            selectedCategories: new Set(),
            selectedIndices: new Set()
        };

        let resetState = {
            userId: null,
            handle: null
        };

        // ==========================================
        // SESSION MANAGEMENT
        // ==========================================
        function saveSession() {
            sessionStorage.setItem('imladris_user', JSON.stringify(currentUser));
            localStorage.setItem('imladris_last_activity', Date.now());
        }

        function restoreSession() {
            const saved = sessionStorage.getItem('imladris_user');
            if (saved) {
                try {
                    currentUser = JSON.parse(saved);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            return false;
        }

        function clearSession() {
            currentUser = { userId: null, handle: null, organization: null };
            sessionStorage.removeItem('imladris_user');
            localStorage.removeItem('imladris_last_activity');
        }

        function updateLastActivity() {
            const last = localStorage.getItem('imladris_last_activity');
            if (last) {
                const elapsed = Date.now() - parseInt(last);
                const minutes = Math.floor(elapsed / 60000);
                const elem = document.getElementById('lastActivity');
                if (elem) {
                    if (minutes < 1) elem.textContent = 'just now';
                    else if (minutes === 1) elem.textContent = '1 minute ago';
                    else elem.textContent = minutes + ' minutes ago';
                }
            }
            localStorage.setItem('imladris_last_activity', Date.now());
        }

        setInterval(updateLastActivity, 30000);

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        function showMessage(text, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message show ' + type;
            setTimeout(() => messageDiv.classList.remove('show'), 5000);
        }

        function togglePIN(inputId, toggleElement) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                toggleElement.textContent = 'üôà';
            } else {
                input.type = 'password';
                toggleElement.textContent = 'üëÅÔ∏è';
            }
        }

        function showScreen(screenId) {
            const screens = ['loginScreen', 'mainApp'];
            screens.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showAuthForm(formId) {
            const forms = ['loginForm', 'createForm', 'resetForm'];
            forms.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(formId).classList.remove('hidden');
        }

        // ==========================================
        // LOGIN SYSTEM
        // ==========================================
        const loginHandle = document.getElementById('loginHandle');
        const loginPIN = document.getElementById('loginPIN');
        const loginBtn = document.getElementById('loginBtn');

        loginHandle.addEventListener('input', validateLogin);
        loginPIN.addEventListener('input', validateLogin);

        function validateLogin() {
            const handle = loginHandle.value.trim();
            const pin = loginPIN.value.trim();
            loginBtn.disabled = !(handle.length >= 2 && /^[a-z]{2}[0-9]{2}$/i.test(pin));
        }

        loginBtn.addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'Logging in...';

            try {
                const params = new URLSearchParams({
                    action: 'login',
                    handle: loginHandle.value.trim(),
                    pin: loginPIN.value.trim().toLowerCase()
                });

                const response = await fetch(APPS_SCRIPT_URL + '?' + params.toString());
                const result = await response.json();

                if (result.status === 'success') {
                    currentUser = {
                        userId: result.userId,
                        handle: result.handle,
                        organization: result.organization
                    };
                    saveSession();
                    enterApp();
                } else {
                    showMessage(result.message || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Connection error. Please try again.', 'error');
            }

            this.disabled = false;
            this.textContent = 'Log In';
        });

        // ==========================================
        // CREATE PROFILE SYSTEM
        // ==========================================
        const createHandle = document.getElementById('createHandle');
        const createPIN = document.getElementById('createPIN');
        const createOrgSelect = document.getElementById('createOrgSelect');
        const createCustomOrgText = document.getElementById('createCustomOrgText');
        const createEmail = document.getElementById('createEmail');
        const createSecurityQuestion = document.getElementById('createSecurityQuestion');
        const createSecurityAnswer = document.getElementById('createSecurityAnswer');
        const createProfileBtn = document.getElementById('createProfileBtn');

        createHandle.addEventListener('input', validateCreate);
        createPIN.addEventListener('input', validateCreate);
        createOrgSelect.addEventListener('change', function() {
            document.getElementById('createCustomOrg').classList.toggle('show', this.value === 'Other');
            validateCreate();
        });
        createCustomOrgText.addEventListener('input', validateCreate);
        createEmail.addEventListener('input', validateCreate);
        createSecurityQuestion.addEventListener('change', validateCreate);
        createSecurityAnswer.addEventListener('input', validateCreate);

        function validateCreate() {
            const handle = createHandle.value.trim();
            const pin = createPIN.value.trim();
            const org = createOrgSelect.value;
            const customOrg = createCustomOrgText.value.trim();
            const email = createEmail.value.trim();
            const question = createSecurityQuestion.value;
            const answer = createSecurityAnswer.value.trim();

            const handleOk = handle.length >= 2;
            const pinOk = /^[a-z]{2}[0-9]{2}$/i.test(pin);
            const orgOk = org !== '' && (org !== 'Other' || customOrg !== '');
            const emailOk = email === '' || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            const securityOk = question !== '' && answer !== '';

            createProfileBtn.disabled = !(handleOk && pinOk && orgOk && emailOk && securityOk);
        }

        createProfileBtn.addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'Creating...';

            const org = createOrgSelect.value === 'Other' 
                ? createCustomOrgText.value.trim() 
                : createOrgSelect.value;

            try {
                const params = new URLSearchParams({
                    action: 'create_profile',
                    handle: createHandle.value.trim(),
                    pin: createPIN.value.trim().toLowerCase(),
                    organization: org,
                    email: createEmail.value.trim(),
                    securityQuestion: createSecurityQuestion.value,
                    securityAnswer: createSecurityAnswer.value.trim()
                });

                const response = await fetch(APPS_SCRIPT_URL + '?' + params.toString());
                const result = await response.json();

                if (result.status === 'success') {
                    currentUser = {
                        userId: result.userId,
                        handle: result.handle,
                        organization: result.organization
                    };
                    saveSession();
                    showMessage('‚úì Profile created!', 'success');
                    enterApp();
                } else {
                    showMessage(result.message || 'Creation failed', 'error');
                }
            } catch (error) {
                console.error('Create profile error:', error);
                showMessage('Connection error. Please try again.', 'error');
            }

            this.disabled = false;
            this.textContent = 'Create Profile';
        });

        // ==========================================
        // PIN RESET SYSTEM
        // ==========================================
        const resetHandle = document.getElementById('resetHandle');
        const resetNextBtn = document.getElementById('resetNextBtn');
        const resetAnswer = document.getElementById('resetAnswer');
        const resetVerifyBtn = document.getElementById('resetVerifyBtn');
        const resetEmailBtn = document.getElementById('resetEmailBtn');
        const resetCode = document.getElementById('resetCode');
        const resetCodeVerifyBtn = document.getElementById('resetCodeVerifyBtn');
        const resetNewPIN = document.getElementById('resetNewPIN');
        const resetConfirmPIN = document.getElementById('resetConfirmPIN');
        const resetFinalBtn = document.getElementById('resetFinalBtn');

        resetHandle.addEventListener('input', () => {
            resetNextBtn.disabled = resetHandle.value.trim().length < 2;
        });

        resetNextBtn.addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'Loading...';

            try {
                // Get user's security question
                const params = new URLSearchParams({
                    action: 'login',
                    handle: resetHandle.value.trim(),
                    pin: '0000' // Dummy PIN to fail login but get user info
                });

                const response = await fetch(APPS_SCRIPT_URL + '?' + params.toString());
                const result = await response.json();

                // User exists if we get any response
                resetState.handle = resetHandle.value.trim();
                document.getElementById('resetStep1').classList.add('hidden');
                document.getElementById('resetStep2').classList.remove('hidden');
                document.getElementById('resetQuestionLabel').textContent = 'Security Question (from your profile)';
                
            } catch (error) {
                showMessage('Connection error', 'error');
            }

            this.disabled = false;
            this.textContent = 'Next';
        });

        resetVerifyBtn.addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'Verifying...';

            try {
                const params = new URLSearchParams({
                    action: 'verify_security_answer',
                    handle: resetState.handle,
                    answer: resetAnswer.value.trim()
                });

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: params.toString()
                });

                const result = await response.json();

                if (result.status === 'success') {
                    resetState.userId = result.userId;
                    document.getElementById('resetStep2').classList.add('hidden');
                    document.getElementById('resetStep4').classList.remove('hidden');
                } else {
                    showMessage(result.message || 'Incorrect answer', 'error');
                }
            } catch (error) {
                showMessage('Connection error', 'error');
            }

            this.disabled = false;
            this.textContent = 'Verify Answer';
        });

        resetEmailBtn.addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'Sending...';

            try {
                const params = new URLSearchParams({
                    action: 'send_verification_code',
                    handle: resetState.handle
                });

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: params.toString()
                });

                const result = await response.json();

                if (result.status === 'success') {
                    document.getElementById('resetEmailMasked').textContent = 'Code sent to: ' + result.maskedEmail;
                    document.getElementById('resetStep2').classList.add('hidden');
                    document.getElementById('resetStep3').classList.remove('hidden');
                    showMessage('Code sent!', 'success');
                } else {
                    showMessage(result.message || 'Failed to send code', 'error');
                }
            } catch (error) {
                showMessage('Connection error', 'error');
            }

            this.disabled = false;
            this.textContent = 'Send Code to Email';
        });

        resetCodeVerifyBtn.addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'Verifying...';

            try {
                const params = new URLSearchParams({
                    action: 'verify_code',
                    handle: resetState.handle,
                    code: resetCode.value.trim()
                });

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: params.toString()
                });

                const result = await response.json();

                if (result.status === 'success') {
                    resetState.userId = result.userId;
                    document.getElementById('resetStep3').classList.add('hidden');
                    document.getElementById('resetStep4').classList.remove('hidden');
                } else {
                    showMessage(result.message || 'Invalid code', 'error');
                }
            } catch (error) {
                showMessage('Connection error', 'error');
            }

            this.disabled = false;
            this.textContent = 'Verify Code';
        });

        resetNewPIN.addEventListener('input', validateResetPIN);
        resetConfirmPIN.addEventListener('input', validateResetPIN);

        function validateResetPIN() {
            const newPin = resetNewPIN.value.trim();
            const confirmPin = resetConfirmPIN.value.trim();
            const valid = /^[a-z]{2}[0-9]{2}$/i.test(newPin) && newPin === confirmPin;
            resetFinalBtn.disabled = !valid;
        }

        resetFinalBtn.addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'Resetting...';

            try {
                const data = {
                    action: 'reset_pin',
                    userId: resetState.userId,
                    newPin: resetNewPIN.value.trim().toLowerCase()
                };

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                showMessage('‚úì PIN reset successfully!', 'success');
                setTimeout(() => {
                    showAuthForm('loginForm');
                }, 2000);

            } catch (error) {
                showMessage('Reset may have succeeded. Try logging in.', 'warning');
            }

            this.disabled = false;
            this.textContent = 'Reset PIN';
        });

        // ==========================================
        // AUTH UI TOGGLES
        // ==========================================
        document.getElementById('showCreateToggle').addEventListener('click', () => showAuthForm('createForm'));
        document.getElementById('showLoginToggle').addEventListener('click', () => showAuthForm('loginForm'));
        document.getElementById('showResetToggle').addEventListener('click', () => showAuthForm('resetForm'));
        document.getElementById('showLoginFromReset').addEventListener('click', () => showAuthForm('loginForm'));

        // ==========================================
        // MAIN APP
        // ==========================================
        function enterApp() {
            document.getElementById('displayHandle').textContent = currentUser.handle;
            document.getElementById('displayOrg').textContent = currentUser.organization;
            showScreen('mainApp');
            updateLastActivity();
            loadAppData();
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Log out?')) {
                clearSession();
                location.reload();
            }
        });

        // ==========================================
        // DATA LOADING
        // ==========================================
        async function loadAppData() {
            try {
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('mainContent').classList.add('hidden');

                // Load all data
                const [dataResult, categoriesResult, idxResult] = await Promise.all([
                    fetch(APPS_SCRIPT_URL + '?action=get_data&userId=' + currentUser.userId).then(r => r.json()),
                    fetch(APPS_SCRIPT_URL + '?action=get_categories').then(r => r.json()),
                    fetch(APPS_SCRIPT_URL + '?action=get_idx_rules').then(r => r.json())
                ]);

                if (dataResult.status === 'success') {
                    appData.rawData = dataResult.data || [];
                    appData.categories = dataResult.categories || CATEGORIES;
                }

                if (categoriesResult.status === 'success') {
                    appData.categoryDescriptors = {};
                    (categoriesResult.categories || []).forEach(cat => {
                        appData.categoryDescriptors[cat.id] = cat.descriptor;
                    });
                }

                if (idxResult.status === 'success') {
                    appData.idxRules = idxResult.rules || [];
                }

                renderCategoryChips();
                renderIdxChips();
                renderValidationPanel();
                renderGraph();

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

            } catch (error) {
                console.error('Data loading error:', error);
                showMessage('Failed to load data. Check connection.', 'error');
            }
        }

        document.getElementById('refreshBtn').addEventListener('click', loadAppData);

        // ==========================================
        // CATEGORY/IDX CHIPS
        // ==========================================
        function renderCategoryChips() {
            const container = document.getElementById('categoryChips');
            container.innerHTML = '';

            CATEGORIES.forEach(catId => {
                const chip = document.createElement('div');
                chip.className = 'chip' + (appData.selectedCategories.has(catId) ? ' selected' : '');
                chip.innerHTML = `<span class="check">‚úì</span><span>${catId}</span>`;
                chip.onclick = () => toggleCategory(catId);
                chip.title = appData.categoryDescriptors[catId] || catId;
                container.appendChild(chip);
            });

            document.getElementById('categoriesCount').textContent = `(${CATEGORIES.length})`;
        }

        function renderIdxChips() {
            const container = document.getElementById('idxChips');
            container.innerHTML = '';

            appData.idxRules.forEach(rule => {
                const chip = document.createElement('div');
                chip.className = 'chip' + (appData.selectedIndices.has(rule.name) ? ' selected' : '');
                chip.innerHTML = `<span class="check">‚úì</span><span>${rule.name}</span>`;
                chip.onclick = () => toggleIndex(rule.name);
                chip.title = rule.formula;
                container.appendChild(chip);
            });

            document.getElementById('indicesCount').textContent = `(${appData.idxRules.length})`;
        }

        function toggleCategory(catId) {
            if (appData.selectedCategories.has(catId)) {
                appData.selectedCategories.delete(catId);
            } else {
                appData.selectedCategories.add(catId);
            }
            renderCategoryChips();
            renderGraph();
        }

        function toggleIndex(idxName) {
            if (appData.selectedIndices.has(idxName)) {
                appData.selectedIndices.delete(idxName);
            } else {
                appData.selectedIndices.add(idxName);
            }
            renderIdxChips();
            renderGraph();
        }

        function toggleSelector(selectorId) {
            const selector = document.getElementById(selectorId);
            const icon = document.getElementById(selectorId.replace('Selector', 'SelectorIcon'));
            selector.classList.toggle('collapsed');
            icon.textContent = selector.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
        }

        // ==========================================
        // VALIDATION PANEL
        // ==========================================
        function renderValidationPanel() {
            if (appData.rawData.length === 0) {
                document.getElementById('validationPanel').style.display = 'none';
                return;
            }

            document.getElementById('validationPanel').style.display = 'block';

            // Calculate current divergence
            const latest = appData.rawData[appData.rawData.length - 1];
            if (!latest || !latest.OVR) {
                document.getElementById('statusValue').textContent = 'NO DATA';
                document.getElementById('divergenceValue').textContent = '‚Äî';
                return;
            }

            // Calculate IDX_master (average of all categories except OVR)
            const values = [];
            CATEGORIES.forEach(cat => {
                const val = parseFloat(latest[cat]);
                if (!isNaN(val)) values.push(val);
            });

            const idxMaster = values.length > 0 ? values.reduce((a,b) => a+b, 0) / values.length : 0;
            const ovr = parseFloat(latest.OVR);
            const divergence = Math.abs(ovr - idxMaster);

            // Determine status
            let status = 'harmony';
            if (divergence > 3) status = 'alert';
            else if (divergence > 1.5) status = 'caution';

            document.getElementById('statusIndicator').className = 'status-indicator ' + status;
            document.getElementById('statusValue').textContent = status.toUpperCase();
            document.getElementById('divergenceValue').textContent = divergence.toFixed(1) + 'œÉ';

            // Render timeline
            renderTimeline();
        }

        function renderTimeline() {
            const container = document.getElementById('timelineMini');
            container.innerHTML = '';

            const last30 = appData.rawData.slice(-30);
            
            last30.forEach(entry => {
                const values = [];
                CATEGORIES.forEach(cat => {
                    const val = parseFloat(entry[cat]);
                    if (!isNaN(val)) values.push(val);
                });

                if (values.length === 0 || !entry.OVR) {
                    const day = document.createElement('div');
                    day.className = 'timeline-day none';
                    container.appendChild(day);
                    return;
                }

                const idxMaster = values.reduce((a,b) => a+b, 0) / values.length;
                const ovr = parseFloat(entry.OVR);
                const divergence = Math.abs(ovr - idxMaster);

                let status = 'harmony';
                if (divergence > 3) status = 'alert';
                else if (divergence > 1.5) status = 'caution';

                const day = document.createElement('div');
                day.className = 'timeline-day ' + status;
                day.title = entry.Date + ': ' + status + ' (' + divergence.toFixed(1) + 'œÉ)';
                container.appendChild(day);
            });
        }

        // ==========================================
        // GRAPH RENDERING
        // ==========================================
        function renderGraph() {
            const graphElem = document.getElementById('graphAscii');
            
            if (appData.rawData.length === 0) {
                graphElem.textContent = 'No data yet. Add an entry to get started!';
                return;
            }

            // Simple placeholder - full implementation would be extensive
            graphElem.textContent = 'Graph rendering coming in Phase 2...\n\n' +
                                     'Selected Categories: ' + Array.from(appData.selectedCategories).join(', ') + '\n' +
                                     'Selected Indices: ' + Array.from(appData.selectedIndices).join(', ') + '\n\n' +
                                     'Total Entries: ' + appData.rawData.length;
        }

        // ==========================================
        // DATA ENTRY MODAL
        // ==========================================
        document.getElementById('addEntryBtn').addEventListener('click', openEntryModal);

        function openEntryModal() {
            // Set today's date
            document.getElementById('entryDate').valueAsDate = new Date();

            // Build category inputs
            const container = document.getElementById('categoryInputs');
            container.innerHTML = '';

            CATEGORIES.forEach(cat => {
                const group = document.createElement('div');
                group.className = 'category-input-group';
                group.innerHTML = `
                    <label>${cat}</label>
                    <input type="number" id="cat_${cat}" step="0.1" placeholder="0-10">
                `;
                container.appendChild(group);
            });

            // Notes counter
            document.getElementById('entryNotes').addEventListener('input', function() {
                document.getElementById('notesCounter').textContent = this.value.length;
            });

            document.getElementById('entryModal').classList.add('show');
        }

        function closeEntryModal() {
            document.getElementById('entryModal').classList.remove('show');
        }

        document.getElementById('submitEntryBtn').addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'Submitting...';

            const date = document.getElementById('entryDate').value;
            const ovr = document.getElementById('entryOVR').value;
            const notes = document.getElementById('entryNotes').value;

            const values = {};
            CATEGORIES.forEach(cat => {
                const input = document.getElementById('cat_' + cat);
                if (input && input.value !== '') {
                    values[cat] = parseFloat(input.value);
                }
            });

            try {
                const data = {
                    action: 'submit_entry',
                    userId: currentUser.userId,
                    date: date,
                    ovr: ovr,
                    notes: notes,
                    values: values
                };

                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                showMessage('‚úì Entry saved!', 'success');
                closeEntryModal();
                setTimeout(loadAppData, 1000);

            } catch (error) {
                showMessage('Save may have succeeded. Refresh to check.', 'warning');
            }

            this.disabled = false;
            this.textContent = 'Submit Entry';
        });

        // ==========================================
        // PAGE LOAD
        // ==========================================
        window.addEventListener('load', function() {
            if (restoreSession() && currentUser.userId) {
                enterApp();
            } else {
                showScreen('loginScreen');
            }
        });
    </script>
</body>
</html>
